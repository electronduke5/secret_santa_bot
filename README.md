# Telegram Bot - Тайный Санта

Бот для организации игры в Тайного Санту в Telegram.

## Возможности

- Создание групп для игры в Тайного Санту
- Приглашение участников по специальному коду
- Случайное распределение участников (каждый дарит подарок случайному человеку)
- Списки пожеланий к подаркам
- Просмотр участников группы
- Администрирование групп
- Загрузка QR-кодов для получения подарков в пунктах выдачи заказов
- Возможность замены загруженных QR-кодов

## Установка

1. Установите зависимости:
```bash
pip3 install -r requirements.txt
```

2. Токен бота уже настроен в файле `.env`

3. Запустите бота:
```bash
python3 bot.py
```

## Запуск с Docker

### Требования
- Docker
- Docker Compose

### Инструкция

1. **ВАЖНО**: Создайте файл `data.json` перед первым запуском:
```bash
echo '{"groups": {}}' > data.json
```
Это необходимо, чтобы Docker не создал `data.json` как директорию.

2. Убедитесь, что файл `.env` настроен с вашим токеном бота:
```bash
cp .env.example .env
# Отредактируйте .env и добавьте свой BOT_TOKEN
```

3. Запустите бота в Docker:
```bash
docker-compose up -d --build
```

### Полезные команды Docker

```bash
# Просмотр логов
docker-compose logs -f

# Остановка бота
docker-compose down

# Перезапуск бота
docker-compose restart

# Пересборка после изменений в коде
docker-compose up -d --build
```

### Преимущества Docker

- Изолированная среда выполнения
- Не нужно устанавливать Python и зависимости на хост-машину
- Автоматический перезапуск при сбоях
- Данные сохраняются между перезапусками в `data.json`

## Структура проекта

```
santa-bot/
├── bot.py              # Основной файл запуска бота
├── config.py           # Конфигурация (загрузка токена)
├── database.py         # Работа с JSON хранилищем
├── keyboards.py        # Inline клавиатуры
├── handlers/           # Обработчики команд
│   ├── __init__.py
│   ├── start.py       # Команда /start и главное меню
│   ├── groups.py      # Управление группами
│   ├── santa.py       # Распределение участников
│   └── qr_codes.py    # Загрузка и просмотр QR-кодов
├── .env               # Токен бота
├── .env.example       # Пример файла с переменными окружения
├── .gitignore         # Игнорируемые файлы
├── .dockerignore      # Файлы, исключаемые из Docker образа
├── Dockerfile         # Конфигурация Docker образа
├── docker-compose.yml # Конфигурация Docker Compose
├── entrypoint.sh      # Скрипт запуска в Docker
├── data.json          # База данных (JSON)
├── qr_codes/          # Хранилище QR-кодов
├── requirements.txt   # Зависимости
└── README.md          # Документация
```

## Использование

### Для администратора:

1. Отправьте `/start` боту
2. Создайте новую группу
3. Получите пригласительный код
4. Отправьте код участникам
5. Когда все присоединятся, запустите распределение
6. Каждый участник получит сообщение с именем того, кому нужно подарить подарок

### Для участника:

1. Отправьте `/start` боту
2. Присоединитесь к группе по коду
3. Укажите свой список пожеланий (опционально)
4. Дождитесь распределения
5. Получите сообщение с именем получателя подарка

### Работа с QR-кодами:

#### Для дарителя (Тайный Санта):
1. После распределения купите подарок для вашего получателя
2. Оформите доставку в пункт выдачи заказов (ПВЗ)
3. Получите QR-код для получения посылки
4. В боте нажмите "Загрузить QR-код" и отправьте фото QR-кода
5. При необходимости можете заменить QR-код, нажав "Заменить QR-код"

#### Для получателя подарка:
1. После того как ваш Тайный Санта загрузит QR-код, в меню группы появится кнопка "Посмотреть QR-код получения"
2. Нажмите на кнопку, чтобы получить QR-код
3. Используйте этот QR-код для получения подарка в ПВЗ

## Команды

- `/start` - Главное меню
- Создать группу - Создание новой группы
- Присоединиться - Вход в группу по коду
- Мои группы - Список ваших групп

## Особенности

- Минимум 3 участника для распределения
- После распределения нельзя добавить новых участников
- Администратор может отменить распределение и запустить заново
- Все данные хранятся локально в `data.json`
- Алгоритм распределения: случайное перемешивание + круговое распределение
- QR-коды хранятся локально в папке `qr_codes/`
- Каждый даритель может загрузить один QR-код и заменить его при необходимости
- Получатель видит кнопку для просмотра QR-кода только после его загрузки дарителем

## Безопасность

- Токен бота хранится в `.env` файле
- `.env`, `data.json` и `qr_codes/` добавлены в `.gitignore`
- Каждый участник видит только своего получателя
- QR-коды доступны только получателю подарка
